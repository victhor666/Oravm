#!/bin/sh

#variables
RUTA="https://almacenbinariosoracle.blob.core.windows.net/binariosorcl/"
FICH1="LINUX.X64_193000_db_home.zip"
FICH2="LINUX.X64_193000_grid_home.zip"
FICH3="Opatch_12.2.0.1.21_Linux-x86-64.zip"
FICH4="p31750108_190000_Linux-x86-64.zip"
LOG="/tmp/script.log"
##################################################################################################
sudo echo "Arrancamos el script de instalacion" > $LOG

# Usamos el waagent para poner la swap. Lo idear es no usar esto por portabilidad a otros clouders...pero es tan comodo (ojo, la maquina tiene que tener al menos 15GB de espacio temporal)
echo "agregando swap" >>  >> $LOG
sudo service waagent stop >> $LOG
sudo sed -i 's/ResourceDisk.Format=n/ResourceDisk.Format=y/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.EnableSwap=n/ResourceDisk.EnableSwap=y/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.SwapSizeMB=0/ResourceDisk.SwapSizeMB=15000/g' /etc/waagent.conf
sudo cat /etc/waagent.conf |grep Swap >> $LOG
sudo service waagent start >> $LOG

#Particionando los discos
sudo echo "Esperamos a que se monte el disco"
until [ -b /dev/sdc ]
do
     sleep 5
done
echo "formateamos disco2 para software de oracle en xfs" >> $LOG
sudo parted /dev/sdc --script mklabel gpt mkpart xfspart xfs 0% 100%  >> $LOG
sudo mkfs.xfs /dev/sdc1
sudo partprobe /dev/sdc1 
sudo mkdir -p /oracle
sudo mount /dev/sdc1 /oracle
sudo echo UUID=\"`(blkid /dev/sdc1 -s UUID -o value)`\" /oracle        xfs     defaults,nofail         1       2 >> /etc/fstab

#tareas administrativas
sudo mkdir -p /oracle/GRIDINF/19C/soft
sudo mkdir -p /oracle/database/19C/soft


# instalacion de paquetes
# echo "instalamos paquetes" >> $LOG
sudo yum install oracle-database-preinstall-19c-1.0-3.el7.x86_64 -y >> $LOG
sudo chown -R oracle:oinstall /oracle
sudo yum install oracleasm -y >> $LOG
sudo yum install oracleasm-support.x86_64 -y >> $LOG
sudo yum install kmod-oracleasm -y >> $LOG
# sudo yum install oracleasmlib -y >> $LOG

#configuraciones asm
sudo oracleasm configure >> $LOG
sudo oracleasm init >> $LOG

#agregamos grupos
sudo echo "Agregamos grupos" >> $LOG
sudo groupadd -g 54327 asmdba
sudo groupadd -g 54328 asmoper
sudo groupadd -g 54329 asmadmin


#este disco hay que formatearlo aqui para que todo lo del asm este instalado
echo "formateamos disco3 en asm" >> $LOG


sudo parted /dev/sdd --script mklabel gpt mkpart xfspart xfs 0% 100% 
sudo oracleasm createdisk DATA /dev/sdd1 >> $LOG
sudo oracleasm scandisks >> $LOG
sudo oracleasm listdisks >> $LOG


# Descarga de software
sudo wget $RUTA$FICH1 -O /tmp/$FICH1 
sudo wget $RUTA$FICH2 -O /tmp/$FICH2 
# sudo wget $RUTA$FICH3 -O /tmp/$FICH3 
# sudo wget $RUTA$FICH4 -O /tmp/$FICH4 

sudo unzip /tmp/$FICH2 -d /oracle/GRIDINF/19C/soft
sudo unzip /tmp/$FICH1 -d /oracle/database/19C/soft
